import{_ as e}from"./plugin-vue_export-helper-c27b6911.js";import{r as o,o as c,c as l,a as n,b as s,d as t,e as p}from"./app-2d0f66e1.js";const i={},u=n("h1",{id:"_1、localstock到contextvar",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_1、localstock到contextvar","aria-hidden":"true"},"#"),s(" 1、localstock到ContextVar")],-1),k=n("h3",{id:"问题引入",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#问题引入","aria-hidden":"true"},"#"),s(" 问题引入")],-1),r=n("p",null,[s("当前flask版本为"),n("code",null,"3.0.2"),s("，记得之前flask实现线程隔离的时候是使用"),n("code",null,"localstock"),s("来实现的，现在再来看源码出现了ContextVar让我感觉比较陌生，接下来我们就来好好看看flask为什么要使用ContextVar。")],-1),d=n("p",null,"源码对比",-1),v={href:"http://xn--global-2l2m17fk33b.py",target:"_blank",rel:"noopener noreferrer"},b=p(`<div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>_request_ctx_stack <span class="token operator">=</span> LocalStack<span class="token punctuation">(</span><span class="token punctuation">)</span>
_app_ctx_stack <span class="token operator">=</span> LocalStack<span class="token punctuation">(</span><span class="token punctuation">)</span>
current_app <span class="token operator">=</span> LocalProxy<span class="token punctuation">(</span>_find_app<span class="token punctuation">)</span>
request <span class="token operator">=</span> LocalProxy<span class="token punctuation">(</span>partial<span class="token punctuation">(</span>_lookup_req_object<span class="token punctuation">,</span> <span class="token string">&quot;request&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
session <span class="token operator">=</span> LocalProxy<span class="token punctuation">(</span>partial<span class="token punctuation">(</span>_lookup_req_object<span class="token punctuation">,</span> <span class="token string">&quot;session&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
g <span class="token operator">=</span> LocalProxy<span class="token punctuation">(</span>partial<span class="token punctuation">(</span>_lookup_app_object<span class="token punctuation">,</span> <span class="token string">&quot;g&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),m={href:"http://xn--global-291m71hk59a.py",target:"_blank",rel:"noopener noreferrer"},_=p(`<div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>_cv_app<span class="token punctuation">:</span> ContextVar<span class="token punctuation">[</span>AppContext<span class="token punctuation">]</span> <span class="token operator">=</span> ContextVar<span class="token punctuation">(</span><span class="token string">&quot;flask.app_ctx&quot;</span><span class="token punctuation">)</span>
app_ctx<span class="token punctuation">:</span> AppContext <span class="token operator">=</span> LocalProxy<span class="token punctuation">(</span>_cv_app<span class="token punctuation">,</span> unbound_message<span class="token operator">=</span>_no_app_msg<span class="token punctuation">)</span>
current_app<span class="token punctuation">:</span> Flask <span class="token operator">=</span> LocalProxy<span class="token punctuation">(</span>_cv_app<span class="token punctuation">,</span> <span class="token string">&quot;app&quot;</span><span class="token punctuation">,</span> unbound_message<span class="token operator">=</span>_no_app_msg<span class="token punctuation">)</span>
g<span class="token punctuation">:</span> _AppCtxGlobals <span class="token operator">=</span> LocalProxy<span class="token punctuation">(</span>_cv_app<span class="token punctuation">,</span> <span class="token string">&quot;g&quot;</span><span class="token punctuation">,</span> unbound_message<span class="token operator">=</span>_no_app_msg<span class="token punctuation">)</span>

_cv_request<span class="token punctuation">:</span> ContextVar<span class="token punctuation">[</span>RequestContext<span class="token punctuation">]</span> <span class="token operator">=</span> ContextVar<span class="token punctuation">(</span><span class="token string">&quot;flask.request_ctx&quot;</span><span class="token punctuation">)</span>
request_ctx<span class="token punctuation">:</span> RequestContext <span class="token operator">=</span> LocalProxy<span class="token punctuation">(</span>_cv_request<span class="token punctuation">,</span> unbound_message<span class="token operator">=</span>_no_req_msg<span class="token punctuation">)</span>
request<span class="token punctuation">:</span> Request <span class="token operator">=</span> LocalProxy<span class="token punctuation">(</span>_cv_request<span class="token punctuation">,</span> <span class="token string">&quot;request&quot;</span><span class="token punctuation">,</span> unbound_message<span class="token operator">=</span>_no_req_msg<span class="token punctuation">)</span>
session<span class="token punctuation">:</span> SessionMixin <span class="token operator">=</span> LocalProxy<span class="token punctuation">(</span>_cv_request<span class="token punctuation">,</span> <span class="token string">&quot;session&quot;</span><span class="token punctuation">,</span> unbound_message<span class="token operator">=</span>_no_req_msg<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="一、两点疑问" tabindex="-1"><a class="header-anchor" href="#一、两点疑问" aria-hidden="true">#</a> 一、两点疑问</h3><h5 id="问题1-为什么使用contextvar" tabindex="-1"><a class="header-anchor" href="#问题1-为什么使用contextvar" aria-hidden="true">#</a> 问题1：为什么使用ContextVar</h5><h5 id="问题2-flask是不是不再使用栈的方式进行处理应用上下文了" tabindex="-1"><a class="header-anchor" href="#问题2-flask是不是不再使用栈的方式进行处理应用上下文了" aria-hidden="true">#</a> 问题2：flask是不是不再使用栈的方式进行处理应用上下文了</h5>`,4),f={href:"https://y-aong.github.io/orderlines_blog/zh/posts/flask/%E5%AD%A6%E4%BC%9Aflask%E4%BA%86%E8%A7%A3python%E4%B8%8A%E4%B8%8B%E6%96%87.html",target:"_blank",rel:"noopener noreferrer"},y=p(`<p>​ 上下文不是我们这次要讲的重点，我们主要看下为什么从threading.loacl转换到ContextVar。</p><h3 id="二、线程隔离" tabindex="-1"><a class="header-anchor" href="#二、线程隔离" aria-hidden="true">#</a> 二、线程隔离</h3><p>threading.loacl是为线程开辟了一块单独的空间，每个线程之间的数据资源可以相互独立。我们可以简单实现下threading.local</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> threading


<span class="token keyword">class</span> <span class="token class-name">Local</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">object</span><span class="token punctuation">.</span>__setattr__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">&#39;storage&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__setattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ident <span class="token operator">=</span> threading<span class="token punctuation">.</span>get_ident<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> ident <span class="token keyword">in</span> self<span class="token punctuation">.</span>storage<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>storage<span class="token punctuation">[</span>ident<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>storage<span class="token punctuation">[</span>ident<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>key<span class="token punctuation">:</span> value<span class="token punctuation">}</span>

    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ident <span class="token operator">=</span> threading<span class="token punctuation">.</span>get_ident<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> ident <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>storage<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>storage<span class="token punctuation">[</span>ident<span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>item<span class="token punctuation">)</span>


local <span class="token operator">=</span> Local<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">task</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    local<span class="token punctuation">.</span>x1 <span class="token operator">=</span> arg
    <span class="token keyword">print</span><span class="token punctuation">(</span>local<span class="token punctuation">.</span>x1<span class="token punctuation">)</span>


<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>task<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>local<span class="token punctuation">,</span> <span class="token string">&#39;storage&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># {44196: {&#39;x1&#39;: 0}, 44228: {&#39;x1&#39;: 1}, 43692: {&#39;x1&#39;: 2}, 41552: {&#39;x1&#39;: 3}, 42804: {&#39;x1&#39;: 4}}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>flask中实现的是</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> greenlet <span class="token keyword">import</span> getcurrent <span class="token keyword">as</span> get_ident
<span class="token keyword">except</span> ImportError<span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">from</span> thread <span class="token keyword">import</span> get_ident
    <span class="token keyword">except</span> ImportError<span class="token punctuation">:</span>
        <span class="token keyword">from</span> _thread <span class="token keyword">import</span> get_ident

<span class="token keyword">class</span> <span class="token class-name">Local</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    __slots__ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">&quot;__storage__&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;__ident_func__&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">object</span><span class="token punctuation">.</span>__setattr__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">&quot;__storage__&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token builtin">object</span><span class="token punctuation">.</span>__setattr__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">&quot;__ident_func__&quot;</span><span class="token punctuation">,</span> get_ident<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>__storage__<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Create a proxy for a name.&quot;&quot;&quot;</span>
        <span class="token keyword">return</span> LocalProxy<span class="token punctuation">(</span>self<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__release_local__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>__storage__<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>self<span class="token punctuation">.</span>__ident_func__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>__storage__<span class="token punctuation">[</span>self<span class="token punctuation">.</span>__ident_func__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span>
        <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> AttributeError<span class="token punctuation">(</span>name<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__setattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ident <span class="token operator">=</span> self<span class="token punctuation">.</span>__ident_func__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        storage <span class="token operator">=</span> self<span class="token punctuation">.</span>__storage__
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            storage<span class="token punctuation">[</span>ident<span class="token punctuation">]</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> value
        <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>
            storage<span class="token punctuation">[</span>ident<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> value<span class="token punctuation">}</span>

    <span class="token keyword">def</span> <span class="token function">__delattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">del</span> self<span class="token punctuation">.</span>__storage__<span class="token punctuation">[</span>self<span class="token punctuation">.</span>__ident_func__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span>
        <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> AttributeError<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到flask这里不仅对于python线程实现了资源隔离，还对协程也实现了数据隔离。而flask引用的werkzeug有对于这个local进行了一层封装封装为了一个栈的形式</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">LocalStack</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_local <span class="token operator">=</span> Local<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">def</span> <span class="token function">_lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            rv <span class="token operator">=</span> self<span class="token punctuation">.</span>top
            <span class="token keyword">if</span> rv <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string">&quot;object unbound&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> rv

        <span class="token keyword">return</span> LocalProxy<span class="token punctuation">(</span>_lookup<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">push</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">:</span>

        rv <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_local<span class="token punctuation">,</span> <span class="token string">&quot;stack&quot;</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> rv <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_local<span class="token punctuation">.</span>stack <span class="token operator">=</span> rv <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        rv<span class="token punctuation">.</span>append<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
        <span class="token keyword">return</span> rv

    <span class="token keyword">def</span> <span class="token function">pop</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        stack <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_local<span class="token punctuation">,</span> <span class="token string">&quot;stack&quot;</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> stack <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        <span class="token keyword">elif</span> <span class="token builtin">len</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            release_local<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_local<span class="token punctuation">)</span>
            <span class="token keyword">return</span> stack<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> stack<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@property</span>
    <span class="token keyword">def</span> <span class="token function">top</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_local<span class="token punctuation">.</span>stack<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">except</span> <span class="token punctuation">(</span>AttributeError<span class="token punctuation">,</span> IndexError<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>而我们使用ContextVar同样也可以实现线程隔离的方式，同时可以基于协程实现线程隔离</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> contextvars

<span class="token comment"># 申明Context变量</span>
request <span class="token operator">=</span> contextvars<span class="token punctuation">.</span>ContextVar<span class="token punctuation">(</span><span class="token string">&#39;Id of request&#39;</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#39;Request ID (Inner): </span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&#39;</span></span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>req_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    request<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>req_id<span class="token punctuation">)</span>
    <span class="token keyword">await</span> get<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> req_id <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        tasks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>test<span class="token punctuation">(</span>req_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">*</span>tasks<span class="token punctuation">)</span>


asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Request ID (Inner): 1</span>
<span class="token comment"># Request ID (Inner): 2</span>
<span class="token comment"># Request ID (Inner): 3</span>
<span class="token comment"># Request ID (Inner): 4</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>因此我们回答第一个问题</p><p>就是<strong>为什么使用ContextVar</strong>，因为它同样可以实现线程隔离的方式，而且是python自带的模块(python3.7后开始全部支持)，也是可以实现协程隔离。功能一致，python原生支持所以使用。</p><h3 id="三、flask是不是不再使用localstock来处理上下文了" tabindex="-1"><a class="header-anchor" href="#三、flask是不是不再使用localstock来处理上下文了" aria-hidden="true">#</a> 三、flask是不是不再使用LocalStock来处理上下文了</h3><p>先说答案，是的flask不再使用LocalStock来处理上下文</p><p>来看源码</p><p>旧版flask ctx</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code> _app_ctx_stack <span class="token operator">=</span> LocalStack<span class="token punctuation">(</span><span class="token punctuation">)</span>
 
 
 <span class="token keyword">class</span> <span class="token class-name">AppContext</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>app <span class="token operator">=</span> app
        self<span class="token punctuation">.</span>url_adapter <span class="token operator">=</span> app<span class="token punctuation">.</span>create_url_adapter<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>g <span class="token operator">=</span> app<span class="token punctuation">.</span>app_ctx_globals_class<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># Like request context, app contexts can be pushed multiple times</span>
        <span class="token comment"># but there a basic &quot;refcount&quot; is enough to track them.</span>
        self<span class="token punctuation">.</span>_refcnt <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">push</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Binds the app context to the current context.&quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>_refcnt <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>sys<span class="token punctuation">,</span> <span class="token string">&quot;exc_clear&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            sys<span class="token punctuation">.</span>exc_clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
        _app_ctx_stack<span class="token punctuation">.</span>push<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
        appcontext_pushed<span class="token punctuation">.</span>send<span class="token punctuation">(</span>self<span class="token punctuation">.</span>app<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">pop</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> exc<span class="token operator">=</span>_sentinel<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Pops the app context.&quot;&quot;&quot;</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_refcnt <span class="token operator">-=</span> <span class="token number">1</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>_refcnt <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> exc <span class="token keyword">is</span> _sentinel<span class="token punctuation">:</span>
                    exc <span class="token operator">=</span> sys<span class="token punctuation">.</span>exc_info<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
                self<span class="token punctuation">.</span>app<span class="token punctuation">.</span>do_teardown_appcontext<span class="token punctuation">(</span>exc<span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            rv <span class="token operator">=</span> _app_ctx_stack<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> rv <span class="token keyword">is</span> self<span class="token punctuation">,</span> <span class="token string">&quot;Popped wrong app context.  (%r instead of %r)&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>rv<span class="token punctuation">,</span> self<span class="token punctuation">)</span>
        appcontext_popped<span class="token punctuation">.</span>send<span class="token punctuation">(</span>self<span class="token punctuation">.</span>app<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>push<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self

    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> exc_type<span class="token punctuation">,</span> exc_value<span class="token punctuation">,</span> tb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>exc_value<span class="token punctuation">)</span>

        <span class="token keyword">if</span> BROKEN_PYPY_CTXMGR_EXIT <span class="token keyword">and</span> exc_type <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            reraise<span class="token punctuation">(</span>exc_type<span class="token punctuation">,</span> exc_value<span class="token punctuation">,</span> tb<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到旧版本确实使用local stock来作为context</p><p>新版本</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">_AppCtxGlobals</span><span class="token punctuation">:</span>
 
    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> t<span class="token punctuation">.</span>Any<span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
        <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> AttributeError<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">__setattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Any<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> value

    <span class="token keyword">def</span> <span class="token function">__delattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">del</span> self<span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
        <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> AttributeError<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Any <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> t<span class="token punctuation">.</span>Any<span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__dict__<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">,</span> default<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">pop</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Any <span class="token operator">=</span> _sentinel<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> t<span class="token punctuation">.</span>Any<span class="token punctuation">:</span>
        <span class="token keyword">if</span> default <span class="token keyword">is</span> _sentinel<span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>__dict__<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>__dict__<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>name<span class="token punctuation">,</span> default<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">setdefault</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Any <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> t<span class="token punctuation">.</span>Any<span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__dict__<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span>name<span class="token punctuation">,</span> default<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__contains__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> item <span class="token keyword">in</span> self<span class="token punctuation">.</span>__dict__

    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> t<span class="token punctuation">.</span>Iterator<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        ctx <span class="token operator">=</span> _cv_app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> ctx <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f&quot;&lt;flask.g of &#39;</span><span class="token interpolation"><span class="token punctuation">{</span>ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span><span class="token string">&#39;&gt;&quot;</span></span>
        <span class="token keyword">return</span> <span class="token builtin">object</span><span class="token punctuation">.</span>__repr__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>新版本已经使用一个类似于dict来存储应用上下文了。</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">AppContext</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;The app context contains application-specific information. An app
    context is created and pushed at the beginning of each request if
    one is not already active. An app context is also pushed when
    running CLI commands.
    &quot;&quot;&quot;</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> app<span class="token punctuation">:</span> Flask<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>app <span class="token operator">=</span> app
        self<span class="token punctuation">.</span>url_adapter <span class="token operator">=</span> app<span class="token punctuation">.</span>create_url_adapter<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>g<span class="token punctuation">:</span> _AppCtxGlobals <span class="token operator">=</span> app<span class="token punctuation">.</span>app_ctx_globals_class<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_cv_tokens<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span>contextvars<span class="token punctuation">.</span>Token<span class="token punctuation">[</span>AppContext<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">push</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Binds the app context to the current context.&quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>_cv_tokens<span class="token punctuation">.</span>append<span class="token punctuation">(</span>_cv_app<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">)</span>
        appcontext_pushed<span class="token punctuation">.</span>send<span class="token punctuation">(</span>self<span class="token punctuation">.</span>app<span class="token punctuation">,</span> _async_wrapper<span class="token operator">=</span>self<span class="token punctuation">.</span>app<span class="token punctuation">.</span>ensure_sync<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">pop</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> exc<span class="token punctuation">:</span> BaseException <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> _sentinel<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>  <span class="token comment"># type: ignore</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Pops the app context.&quot;&quot;&quot;</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_cv_tokens<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> exc <span class="token keyword">is</span> _sentinel<span class="token punctuation">:</span>
                    exc <span class="token operator">=</span> sys<span class="token punctuation">.</span>exc_info<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
                self<span class="token punctuation">.</span>app<span class="token punctuation">.</span>do_teardown_appcontext<span class="token punctuation">(</span>exc<span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            ctx <span class="token operator">=</span> _cv_app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
            _cv_app<span class="token punctuation">.</span>reset<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_cv_tokens<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> ctx <span class="token keyword">is</span> <span class="token keyword">not</span> self<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> AssertionError<span class="token punctuation">(</span>
                <span class="token string-interpolation"><span class="token string">f&quot;Popped wrong app context. (</span><span class="token interpolation"><span class="token punctuation">{</span>ctx<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> instead of </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)&quot;</span></span>
            <span class="token punctuation">)</span>

        appcontext_popped<span class="token punctuation">.</span>send<span class="token punctuation">(</span>self<span class="token punctuation">.</span>app<span class="token punctuation">,</span> _async_wrapper<span class="token operator">=</span>self<span class="token punctuation">.</span>app<span class="token punctuation">.</span>ensure_sync<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> AppContext<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>push<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self

    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        exc_type<span class="token punctuation">:</span> <span class="token builtin">type</span> <span class="token operator">|</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        exc_value<span class="token punctuation">:</span> BaseException <span class="token operator">|</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        tb<span class="token punctuation">:</span> TracebackType <span class="token operator">|</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>exc_value<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们来总结下</p><h4 id="_1、第一实现多线程、协程数据隔离-我们可以使用的方式" tabindex="-1"><a class="header-anchor" href="#_1、第一实现多线程、协程数据隔离-我们可以使用的方式" aria-hidden="true">#</a> 1、第一实现多线程、协程数据隔离，我们可以使用的方式</h4><ul><li><p>有原生的from thread import get_ident，from greenlet import getcurrent as get_ident</p></li><li><p>原生模块：ContextVar</p></li><li><p>第三方模块：from werkzeug.local import Local</p></li><li><p>flask中已经率先使用ContextVar来做数据隔离，放弃使用了LocalStock。</p></li><li><p>flask之前为什么为什么放弃使用栈：</p></li></ul><p>​ 其实并不是非要用栈这种数据格式不可，只要我们可以实现多个请求过来实现数据隔离就可以了，重点不是非要使用栈来做这种数据格式，重点是要实现数据隔离，而ContextVar也是实现数据隔离这个需求。</p><h4 id="_2、那之前为什么要使用栈呢" tabindex="-1"><a class="header-anchor" href="#_2、那之前为什么要使用栈呢" aria-hidden="true">#</a> 2、那之前为什么要使用栈呢？</h4><p>Flask 在多应用的情况下，依旧可以通过 request.path 获得当前应用的信息，实现这个效果的前提就是，Flask 知道当前请求对应的上下文。栈结构很好的实现了这个前提，每个请求，其相关的上下文就在栈顶，直接将栈顶上下文出栈就可以获得当前请求对应上下文中的信息了。</p><p>这是因为 Flask 的上下文中保存的数据都是存放在栈里并且会动态变化的，通过 LocalProxy 可以动态的访问相应的对象，从而避免造成数据访问异常。</p><h4 id="_3、现在为什么不使用栈了" tabindex="-1"><a class="header-anchor" href="#_3、现在为什么不使用栈了" aria-hidden="true">#</a> 3、现在为什么不使用栈了？</h4><p>因为我们使用ContextVar会更加智能的知道当前的请求，以及当前的数据，ContextVar中的set和get方法，同样可以实现动态的访问相应的对象，从而避免造成数据访问异常。</p>`,31);function g(w,x){const a=o("ExternalLinkIcon");return c(),l("div",null,[u,k,r,d,n("p",null,[n("a",v,[s("旧版本global.py"),t(a)])]),b,n("p",null,[n("a",m,[s("新版本global.py"),t(a)])]),_,n("p",null,[s("​ 在Python 3.7加入了一个新的模块contextvars，标题是 Context Variables，也就是「上下文变量」。那么什么是上下文呢。可以参考这个文章"),n("a",f,[s("flask with上下文"),t(a)]),s("。简单来说就是上下文，相当于现实生活中的上下文语义，在python中脱离了上下文环境所声明的类，属性可能会失效。")]),y])}const C=e(i,[["render",g],["__file","1、threading.local到ContextVar.html.vue"]]);export{C as default};
